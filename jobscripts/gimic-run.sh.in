#!/bin/bash

# Function definitions:
source @SCRIPTS_DIR@/functions-def
# Usage:
# centroid $atomic_indices_according_to_the_coord_file
# dista $index_of_atom1 $index_of_atom2

echo
echo "Bond between the atoms:"
read atom1; read atom2
bond=$atom1","$atom2

echo "Enter the suffix for the directory name"
read suffix
suffix=$(printf _$suffix)
dirname=bond_int_$atom1.$atom2$suffix
echo $dirname

# If we are not in the current_profile folder, check if it exists. If it did, just go there. If it did not, create it and copy the necessary files
dir=$(pwd | grep "bond_int")
#echo $dir

checkIfPreviousCalculationExists $dir

# Calculate the distance between the atoms
echo "Define where between the two atoms the integration plane passes"
echo "Default: through the midpoint"
#echo dista $atom1 $atom2
#echo $(dista $atom1 $atom2)

distance=$( dista $atom1 $atom2 )
echo distance=$distance

valueInp distance $distance


# Coordinates of the centre of the bond:
BOND=$(centroid $atom1 $atom2)
Bx=$( echo $BOND | awk '{print $1} ' )
By=$( echo $BOND | awk '{print $2} ' )
Bz=$( echo $BOND | awk '{print $3} ' )

# echo "Bond centre coordinates:"
# printf "("$Bx"; "$By"; "$Bz")\n"

echo

# Read the coordinates of atom1:
A1z=$( awk -v atom1=$atom1 '{ if (NR==(atom1+1)) {print $3} }' coord  )

# Read the coordinates of atom2:
A2x=$( awk -v atom2=$atom2 '{ if (NR==(atom2+1)) {print $1} }' coord  )
A2y=$( awk -v atom2=$atom2 '{ if (NR==(atom2+1)) {print $2} }' coord  )
A2z=$( awk -v atom2=$atom2 '{ if (NR==(atom2+1)) {print $3} }' coord  )

# Fx=$(calculateFixedCoord $A2x $A2y $A2z | awk '{print $1}')
# Fy=$(calculateFixedCoord $A2x $A2y $A2z | awk '{print $2}')
# #Fz=$( awk -v A1z=$A1z -v A2z=$A2z 'BEGIN{ print (A1z+A2z)*0.5 }')
# Fz=$( awk -v A1z=$A1z -v A2z=$A2z 'BEGIN{ print A2z }')
# 
# echo "Fixed coordinate: ($Fx; $Fy; $Fz)"
# 

printf "\n\nSTARTING POINT OF THE INTEGRATION\n"
userInp start $start
tmp=$( awk -v start=$start 'BEGIN{ print -start }' )
start=$tmp

printf "\nEND POINT OF THE INTEGRATION\n"
out=10
printf "\nDo you accept out=$out bohr?"
userInp out $out

printf "\n\nUPPER AND LOWER BOUNDS OF THE INTEGRATION\n"
up=10
down=-10
valueInp up $up 
valueInp down $down

echo "MAGNETIC FIELD DIRECTION"

# default along the Z axis
MFx=0.0
MFy=0.0
MFz=-1.0

echo "Do you accept the default MF orientation along the Z axis?"
echo "Press [n] to calculate the direction automatically" # TODO: or [e] to enter manually"

read accept;
if [ ! -z $accept ] && [ $accept == "n" ]
then
   maximise_projection coord.xyz > $dirname/field.dat
   MFx=$( cat $dirname/field.dat | sed -e 's#{#_#g; s#}#_#g; s#,#_#g' | awk -F [_] '{ {print -$2} }')
   MFy=$( cat $dirname/field.dat | sed -e 's#{#_#g; s#}#_#g; s#,#_#g' | awk -F [_] '{ {print -$3} }')
   MFz=$( cat $dirname/field.dat | sed -e 's#{#_#g; s#}#_#g; s#,#_#g' | awk -F [_] '{ {print -$4} }')
fi

echo "Magnetic field vector coordinates: ($MFx; $MFy; $MFz)"

# fixed point (Ax, Ay and Az are the coords of the bond atoms 1 and 2)
Fx=$(calculateFixedCoord $A2x $A2y $A2z | awk '{print $1}')
Fy=$(calculateFixedCoord $A2x $A2y $A2z | awk '{print $2}')
#Fz=$( awk -v A1z=$A1z -v A2z=$A2z 'BEGIN{ print (A1z+A2z)*0.5 }')
#Fz=$( awk -v A1z=$A1z -v A2z=$A2z 'BEGIN{ print A2z }')

# use the coords of atom 1 and the MF vector
# vector OA and OF defined with the coords of atom1 and the fixed point
# vector AF.MF = 0
Fz=$( awk -v Ax=$A1x -v Fx=$Fx -v Ay=$A1y -v Fy=$Fy -v Az=$A1z -v mx=$MFx -v my=$MFy -v mz=$MFz 'BEGIN{ print( ( (mx*(Fx-Ax) + my*(Fy-Ay)) / mz) + Az )}')

echo "Fixed coordinate: ($Fx; $Fy; $Fz)"






spacingX=0.02
spacingY=0.02
spacingZ=0.02

printf "\n\nSPACING\n"
printf  "\nDo you accept spacing=[$spacingX, $spacingY, $spacingZ]?\nPress [n] to change\n"
read accept;
if [ ! -z $accept ] && [ $accept == "n" ]
then
    printf "spacingX="; read spacingX
    printf "spacingY="; read spacingY
    printf "spacingZ="; read spacingZ
fi


string="s/@bond@/$bond/; s/@fixed@/$fixed/; s/@distance@/$distance/; s/@up@/$up/; s/@down@/$down/; s/@start@/$start/; s/@end@/$out/; s/@FX@/$Fx/; s/@FY@/$Fy/; s/@FZ@/$Fz/; s/@MFx@/$MFx/; s/@MFy@/$MFy/; s/@MFz@/$MFz/; s/@spacingX@/$spacingX/; s/@spacingY@/$spacingY/; s/@spacingZ@/$spacingZ/; "
sed "$string" @SCRIPTS_DIR@/gimic.Inp > ./$dirname/gimic.inp

printf "Performing dryrun...\n\n"
(cd ./$dirname/ && gimic --dryrun gimic.inp | grep "grid points" )
printf "\n\n"

echo "Ready for analysis"

